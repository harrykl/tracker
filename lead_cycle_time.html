<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Durchschnitt Cycle- & Lead-Time (letzte 90 Tage + morgen)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      text-align: center;
    }
    canvas {
      max-width: 100%;
      height: 450px;
    }
  </style>
</head>
<body>
  <h1>Durchschnitt Cycle- & Lead-Time (letzte 90 Tage + morgen)</h1>
  <p>Datenquelle: <code>Prozessmetriken/issue_project_status.csv</code></p>
  <p id="statusMsg">Lade Daten...</p>

  <canvas id="timeChart"></canvas>

  <script>
    const csvUrl = 'https://raw.githubusercontent.com/harrykl/tracker/main/Prozessmetriken/issue_project_status.csv';

    // Hilfsfunktion: Erstelle Array mit allen Tagen von start bis ende (yyyy-mm-dd)
    function getDateRangeArray(start, end) {
      const arr = [];
      let dt = new Date(start);
      while (dt <= end) {
        arr.push(dt.toISOString().slice(0, 10));
        dt.setDate(dt.getDate() + 1);
      }
      return arr;
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;

        if (!data.length) {
          document.getElementById('statusMsg').innerText = 'Keine Daten gefunden.';
          return;
        }

        // Aktuelles Datum (heute), Startdatum 90 Tage davor, Enddatum morgen
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 90);
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + 1); // morgen

        // Erzeuge alle Tage im Zeitraum
        const allDates = getDateRangeArray(startDate, endDate);

        // Struktur: Für jeden Tag Summe LeadTime, Summe CycleTime, Count
        const dailyStats = {};
        allDates.forEach(d => {
          dailyStats[d] = { leadSum: 0, cycleSum: 0, count: 0 };
        });

        data.forEach(row => {
          // Nutze 'ClosedAt' als Schließdatum, alternativ 'closed_at' - bitte ggf. anpassen!
          const closedAt = row['ClosedAt'] || row['closed_at'];
          const leadTimeStr = row['Lead Time (days)'] || row['Lead Time (days)'];
          const cycleTimeStr = row['Cycle Time (days)'] || row['Cycle Time (days)'];

          if (!closedAt || !leadTimeStr || !cycleTimeStr) return;

          const closedDate = new Date(closedAt);
          if (isNaN(closedDate)) return;

          // Datum YYYY-MM-DD
          const closedDateStr = closedDate.toISOString().slice(0, 10);

          // Nur wenn im Zeitraum (letzte 90 Tage bis morgen)
          if (closedDate < startDate || closedDate > endDate) return;

          const leadTime = parseFloat(leadTimeStr.replace(',', '.'));
          const cycleTime = parseFloat(cycleTimeStr.replace(',', '.'));
          if (isNaN(leadTime) || isNaN(cycleTime)) return;

          if (!dailyStats[closedDateStr]) dailyStats[closedDateStr] = { leadSum: 0, cycleSum: 0, count: 0 };

          dailyStats[closedDateStr].leadSum += leadTime;
          dailyStats[closedDateStr].cycleSum += cycleTime;
          dailyStats[closedDateStr].count++;
        });

        // Daten für Chart vorbereiten
        const labels = [];
        const avgLeadTimes = [];
        const avgCycleTimes = [];

        allDates.forEach(dateStr => {
          labels.push(dateStr);
          const dayData = dailyStats[dateStr];
          if (dayData.count > 0) {
            avgLeadTimes.push(dayData.leadSum / dayData.count);
            avgCycleTimes.push(dayData.cycleSum / dayData.count);
          } else {
            // Kein Wert für diesen Tag - setze null, damit Chart.js Lücken anzeigt
            avgLeadTimes.push(null);
            avgCycleTimes.push(null);
          }
        });

        drawChart(labels, avgLeadTimes, avgCycleTimes);

        document.getElementById('statusMsg').innerText = 'Diagramm erfolgreich geladen.';
      },

      error: function(err) {
        document.getElementById('statusMsg').innerText = 'Fehler beim Laden der CSV.';
        console.error(err);
      }
    });

    function drawChart(labels, avgLead, avgCycle) {
      const ctx = document.getElementById('timeChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Durchschnitt Lead Time (Tage)',
              data: avgLead,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 7,
              spanGaps: false
            },
            {
              label: 'Durchschnitt Cycle Time (Tage)',
              data: avgCycle,
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 7,
              spanGaps: false
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              title: { display: true, text: 'Datum' },
              ticks: { maxTicksLimit: 15 }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Durchschnitt (Tage)' }
            }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y !== null ? ctx.parsed.y.toFixed(2) : 'kein Wert'} Tage`
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
