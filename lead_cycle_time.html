<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Rolling Durchschnitt Cycle- & Lead-Time (letzte 90 Tage + morgen)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      text-align: center;
    }
    canvas {
      max-width: 100%;
      height: 450px;
    }
  </style>
</head>
<body>
  <h1>Rolling Durchschnitt Cycle- & Lead-Time (letzte 90 Tage + morgen)</h1>
  <p>Datenquelle: <code>Prozessmetriken/issue_project_status.csv</code></p>
  <p id="statusMsg">Lade Daten...</p>

  <canvas id="timeChart"></canvas>

  <script>
    const csvUrl = 'https://raw.githubusercontent.com/harrykl/tracker/main/Prozessmetriken/issue_project_status.csv';

    // Hilfsfunktion: Erzeuge Array mit Tagen von start bis ende (yyyy-mm-dd)
    function getDateRangeArray(start, end) {
      const arr = [];
      let dt = new Date(start);
      while (dt <= end) {
        arr.push(dt.toISOString().slice(0, 10));
        dt.setDate(dt.getDate() + 1);
      }
      return arr;
    }

    // Hilfsfunktion: Datum ohne Zeit, als yyyy-mm-dd string
    function formatDate(d) {
      return d.toISOString().slice(0, 10);
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;

        if (!data.length) {
          document.getElementById('statusMsg').innerText = 'Keine Daten gefunden.';
          return;
        }

        // Hole alle ClosedAt-Daten mit LeadTime und CycleTime in ein Array mit Datum-Objekten
        const issues = [];
        data.forEach(row => {
          const closedAt = row['ClosedAt'] || row['closed_at'];
          const leadTimeStr = row['Lead Time (days)'] || row['Lead Time (days)'];
          const cycleTimeStr = row['Cycle Time (days)'] || row['Cycle Time (days)'];

          if (!closedAtStr || !leadTimeStr || !cycleTimeStr) return;

          const closedAtDate = new Date(closedAtStr);
          if (isNaN(closedAtDate)) return;

          const leadTime = parseFloat(leadTimeStr.replace(',', '.'));
          const cycleTime = parseFloat(cycleTimeStr.replace(',', '.'));

          if (isNaN(leadTime) || isNaN(cycleTime)) return;

          issues.push({
            closedAt: closedAtDate,
            leadTime,
            cycleTime
          });
        });

        // Zeitraum für X-Achse: von heute-90 bis morgen
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 90);
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + 1);

        const allDates = getDateRangeArray(startDate, endDate);

        // Für jeden Tag t in allDates berechnen wir den Durchschnitt aller Issues, die in
        // [t-90 Tage .. t] geschlossen wurden (rolling window)
        const avgLeadTimes = [];
        const avgCycleTimes = [];

        for (const dayStr of allDates) {
          const day = new Date(dayStr);

          // Intervallstart: day - 90 Tage
          const windowStart = new Date(day);
          windowStart.setDate(day.getDate() - 90);

          // Filter Issues in diesem Zeitraum
          const filteredIssues = issues.filter(issue => {
            return issue.closedAt >= windowStart && issue.closedAt <= day;
          });

          if (filteredIssues.length === 0) {
            avgLeadTimes.push(null);
            avgCycleTimes.push(null);
          } else {
            // Durchschnitt berechnen
            const sumLead = filteredIssues.reduce((sum, i) => sum + i.leadTime, 0);
            const sumCycle = filteredIssues.reduce((sum, i) => sum + i.cycleTime, 0);

            avgLeadTimes.push(sumLead / filteredIssues.length);
            avgCycleTimes.push(sumCycle / filteredIssues.length);
          }
        }

        drawChart(allDates, avgLeadTimes, avgCycleTimes);
        document.getElementById('statusMsg').innerText = 'Diagramm erfolgreich geladen.';
      },

      error: function(err) {
        document.getElementById('statusMsg').innerText = 'Fehler beim Laden der CSV.';
        console.error(err);
      }
    });

    function drawChart(labels, avgLead, avgCycle) {
      const ctx = document.getElementById('timeChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Rolling Durchschnitt Lead Time (Tage)',
              data: avgLead,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 7,
              spanGaps: false
            },
            {
              label: 'Rolling Durchschnitt Cycle Time (Tage)',
              data: avgCycle,
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 7,
              spanGaps: false
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              title: { display: true, text: 'Datum' },
              ticks: { maxTicksLimit: 15 }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Durchschnitt (Tage)' }
            }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y !== null ? ctx.parsed.y.toFixed(2) : 'kein Wert'} Tage`
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
